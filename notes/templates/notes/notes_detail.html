{% extends '_base.html' %}


{% block content %}
<div class="mx-auto max-w-3xl space-y-6">
  <div class="rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm">
    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Note</p>
        <h2 class="text-3xl text-slate-900">{{ note.title }}</h2>
        <p class="mt-2 text-sm text-slate-500">By {{ note.user.username }}</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        {% if note.category %}
        <span class="rounded-full bg-teal-50 px-3 py-1 text-xs font-medium text-teal-700">
          {{ note.category.name }}
        </span>
        {% endif %}
        {% if note.is_public %}
        <span class="rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700">
          Public
        </span>
        {% endif %}
        {% if note.tags.count %}
          {% for tag in note.tags.all %}
          <span class="rounded-full border border-amber-200 bg-amber-50 px-2.5 py-0.5 text-xs text-amber-700">
            {{ tag.name }}
          </span>
          {% endfor %}
        {% endif %}
      </div>
    </div>
    <div class="mt-6 max-h-[420px] overflow-y-auto rounded-xl border border-slate-100 bg-white p-5 text-sm text-slate-700">
      {{ note.rendered_text | safe }}
    </div>
    <div class="mt-6 flex flex-wrap items-center gap-3 text-sm">
      <a href="{% url 'notes.list' %}"
         class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-slate-600 transition hover:bg-slate-50">
        Back to notes
      </a>
      <a href="{% url 'notes.update' pk=note.id %}"
         class="inline-flex items-center gap-2 rounded-lg border border-teal-200 bg-teal-50 px-4 py-2 text-teal-700 transition hover:bg-teal-100">
        Edit note
      </a>
      <a href="{% url 'notes.delete' pk=note.id %}"
         class="inline-flex items-center gap-2 rounded-lg border border-rose-200 bg-rose-50 px-4 py-2 text-rose-700 transition hover:bg-rose-100">
        Delete
      </a>
    </div>
  </div>
  <p class="text-xs text-slate-500">Last updated {{ note.updated_at|date:"F d, Y, H:i" }}</p>
</div>

{% if note.user_id == user.id %}
<div class="mx-auto max-w-3xl rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-slate-400">Share</p>
      <h3 class="text-xl text-slate-900">Share this note</h3>
    </div>
  </div>
  <div class="mt-4 grid gap-4 md:grid-cols-2">
    <form method="post" action="{% url 'notes.share_users' note_id=note.id %}" class="space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">
      <input type="hidden" name="redirect" value="true">
      <label class="block text-sm font-medium text-slate-700">Share with user</label>
      <select name="user_id" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
        {% for share_user in share_users %}
          <option value="{{ share_user.id }}">{{ share_user.username }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="rounded-lg bg-teal-700 px-3 py-2 text-xs font-medium text-white">Share</button>
    </form>

    <form method="post" action="{% url 'notes.share_groups.share' note_id=note.id %}" class="space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">
      <input type="hidden" name="redirect" value="true">
      <label class="block text-sm font-medium text-slate-700">Share with group</label>
      <select name="group_id" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
        {% for group in share_groups %}
          <option value="{{ group.id }}">{{ group.name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="rounded-lg bg-teal-700 px-3 py-2 text-xs font-medium text-white">Share</button>
    </form>
  </div>

  <div class="mt-6 grid gap-4 md:grid-cols-2">
    <form method="post" action="{% url 'notes.collaborators' note_id=note.id %}" class="space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">
      <input type="hidden" name="redirect" value="true">
      <label class="block text-sm font-medium text-slate-700">Add collaborator</label>
      <div class="flex flex-wrap items-center gap-2">
        <select name="user_id" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
          {% for share_user in share_users %}
            <option value="{{ share_user.id }}">{{ share_user.username }}</option>
          {% endfor %}
        </select>
        <select name="role" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
          <option value="viewer">Viewer</option>
          <option value="editor">Editor</option>
        </select>
        <button type="submit" class="rounded-lg bg-teal-700 px-3 py-2 text-xs font-medium text-white">Add</button>
      </div>
    </form>

    <div class="space-y-2">
      <p class="text-sm font-medium text-slate-700">Collaborators</p>
      <div class="space-y-2">
        {% for collab in note.collaborators.all %}
        <div class="flex items-center justify-between rounded-lg border border-slate-200 p-2 text-xs text-slate-600">
          <span>{{ collab.user.username }} Â· {{ collab.role }}</span>
          <form method="post" action="{% url 'notes.collaborators' note_id=note.id %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="remove">
            <input type="hidden" name="user_id" value="{{ collab.user.id }}">
            <input type="hidden" name="role" value="viewer">
            <input type="hidden" name="redirect" value="true">
            <button type="submit" class="rounded-lg border border-rose-200 px-2 py-1 text-rose-700">Remove</button>
          </form>
        </div>
        {% empty %}
        <p class="text-xs text-slate-500">No collaborators yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="mt-6 grid gap-4 md:grid-cols-2">
    <form method="post" action="{% url 'notes.share_groups' %}" class="space-y-2">
      {% csrf_token %}
      <label class="block text-sm font-medium text-slate-700">Create group</label>
      <div class="flex gap-2">
        <input name="name" type="text" placeholder="Team Alpha" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
        <button type="submit" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600">Create</button>
      </div>
    </form>

    <form method="post" action="{% url 'notes.share_links' note_id=note.id %}" class="space-y-2">
      {% csrf_token %}
      <input type="hidden" name="redirect" value="true">
      <label class="block text-sm font-medium text-slate-700">Create share link</label>
      <div class="flex flex-wrap items-center gap-2">
        <input name="expires_minutes" type="number" min="1" placeholder="Expires (minutes)" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
        <label class="inline-flex items-center gap-2 text-xs text-slate-600">
          <input type="checkbox" name="can_edit" value="true">
          Allow edit
        </label>
        <button type="submit" class="rounded-lg bg-teal-700 px-3 py-2 text-xs font-medium text-white">Create</button>
      </div>
    </form>
  </div>

  <div class="mt-6">
    <p class="text-sm font-medium text-slate-700">Existing share links</p>
    <div class="mt-2 space-y-2">
      {% for link in note.share_links.all %}
        <div class="flex flex-wrap items-center justify-between gap-2 rounded-lg border border-slate-200 p-2 text-xs text-slate-600">
          <span>{{ link.token }}</span>
          <form method="post" action="{% url 'notes.share_links.revoke' note_id=note.id link_id=link.id %}">
            {% csrf_token %}
            <input type="hidden" name="redirect" value="true">
            <button type="submit" class="rounded-lg border border-rose-200 px-2 py-1 text-rose-700">Revoke</button>
          </form>
        </div>
      {% empty %}
        <p class="text-xs text-slate-500">No share links yet.</p>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endblock %}


