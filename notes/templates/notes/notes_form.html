{% extends "_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
  <link rel="stylesheet" href="{% static 'dist/tiptap.css' %}">
  <div class="mx-auto max-w-6xl space-y-6">
    <div class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm md:flex-row md:items-center md:justify-between">
      <div>
        {% if form.instance.pk %}
        <h1 class="text-3xl text-slate-900">Edit note</h1>
        <p class="text-sm text-slate-500">Refine your idea and update the details.</p>
        {% else %}
        <h1 class="text-3xl text-slate-900">Create a new note</h1>
        <p class="text-sm text-slate-500">Draft the story and refine the details on the side.</p>
        {% endif %}
      </div>
      <div class="flex gap-3">
        {% if form.instance.pk %}
        <a href="{% url 'notes.detail' pk=form.instance.pk %}"
           class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition hover:bg-slate-50">
          Cancel
        </a>
        {% else %}
        <a href="{% url 'notes.list' %}"
           class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition hover:bg-slate-50">
          Cancel
        </a>
        {% endif %}
        <button type="submit" form="note-form"
                class="inline-flex items-center justify-center rounded-lg bg-teal-700 px-4 py-2 text-sm font-medium text-white transition hover:bg-teal-800">
          Save note
        </button>
      </div>
    </div>

    <form id="note-form" method="post" class="grid gap-6 lg:grid-cols-3">
      {% csrf_token %}

      <section class="lg:col-span-2 space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm">
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700">
            {{ form.title.label }}
          </label>
          {{ form.title|add_class:"w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-teal-500 focus:ring-2 focus:ring-teal-200"|attr:"placeholder:Enter title here..." }}
        </div>

        <div class="space-y-2">
          <label class="block text-sm font-medium text-slate-700">{{ form.text.label }}</label>
          <div id="tiptap-toolbar" class="tiptap-toolbar flex flex-wrap items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 p-3">
            <button type="button" data-action="bold" title="Bold">B</button>
            <button type="button" data-action="italic" title="Italic">I</button>
            <button type="button" data-action="underline" title="Underline">U</button>
            <button type="button" data-action="strike" title="Strikethrough">S</button>
            <span class="divider"></span>
            <button type="button" data-action="heading2" title="Heading 2">H2</button>
            <button type="button" data-action="heading3" title="Heading 3">H3</button>
            <button type="button" data-action="blockquote" title="Quote">Quote</button>
            <button type="button" data-action="codeBlock" title="Code">Code</button>
            <span class="divider"></span>
            <button type="button" data-action="bulletList" title="Bullet list">Bullets</button>
            <button type="button" data-action="orderedList" title="Numbered list">Numbers</button>
            <button type="button" data-action="link" title="Add link">Link</button>
          </div>
          {{ form.text }}
          <div
            id="tiptap-editor"
            class="tiptap-surface"
            aria-label="Note body"
            data-collab-enabled="{% if form.instance.pk %}true{% else %}false{% endif %}"
            data-note-id="{{ form.instance.pk|default:'' }}"
            data-collab-url="{{ collab_url }}"
            data-user-name="{{ user.username }}"
          ></div>
          {% if form.instance.pk %}
          <p class="text-xs text-slate-500">Live collaboration is enabled for this note.</p>
          {% endif %}
        </div>
      </section>

      <aside class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-sm">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-400">Details</p>
          <h2 class="text-xl text-slate-900">Metadata</h2>
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700">{{ form.category.label }}</label>
          {{ form.category|add_class:"w-full rounded-lg border border-slate-200 text-sm focus:border-teal-500 focus:ring-2 focus:ring-teal-200" }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700">{{ form.shared_with.label }}</label>
          <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm text-slate-600">
            {{ form.shared_with }}
          </div>
          <p class="text-xs text-slate-400">Leave all unchecked to keep this note private.</p>
        </div>
        <div class="space-y-2">
          <label class="block text-sm font-medium text-slate-700">{{ form.tags.label }}</label>
          <div class="rounded-lg border border-slate-200 bg-white p-3 text-sm text-slate-600">
            {{ form.tags }}
          </div>
          {% if tags_count == 0 %}
          <p class="text-xs text-slate-400">No tags yet. Add one below.</p>
          {% endif %}
        </div>
        <form method="post" action="{% url 'tags.create' %}" class="space-y-2">
          {% csrf_token %}
          <label class="block text-sm font-medium text-slate-700">Add a tag</label>
          <div class="flex gap-2">
            <input name="name" type="text" placeholder="e.g. research" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm">
            <button type="submit" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600">Add</button>
          </div>
        </form>
        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
          <label class="flex items-center gap-2 text-sm text-slate-700">
            {{ form.is_public }}
            <span>Share to community</span>
          </label>
          <p class="mt-1 text-xs text-slate-500">Public notes appear on the collaborative feed.</p>
        </div>
        <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4 text-xs text-slate-500">
          Tip: use the toolbar to add headings, quotes, and code blocks for clarity.
        </div>
      </aside>
    </form>

    {% if form.errors %}
    <div role="alert" class="mt-6 rounded-lg border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700">
      <strong class="block font-medium text-rose-800">Please correct the following errors:</strong>
      <ul class="mt-2 list-disc list-inside">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  <script type="module" src="{% static 'dist/tiptap.js' %}"></script>
{% endblock %}
